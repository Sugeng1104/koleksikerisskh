<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel SKH</title>

<style>
body{
    font-family:Georgia,serif;
    background:#111;
    color:white;
    padding:40px;
}
.card{
    max-width:700px;
    margin:auto;
    background:#1e293b;
    padding:25px;
    border-radius:14px;
}
input,textarea{
    width:100%;
    padding:10px;
    margin:6px 0;
    border-radius:8px;
    border:none;
}
button{
    padding:10px 18px;
    border:none;
    border-radius:8px;
    background:#d4af37;
    color:black;
    font-weight:bold;
    cursor:pointer;
    margin-top:5px;
}
.logout{
    background:red;
    color:white;
}
.preview{
    margin-top:10px;
    text-align:center;
}
.preview img{
    max-width:200px;
    border-radius:10px;
    margin-top:10px;
    border:2px solid gold;
}
.list{
    margin-top:30px;
}
.item{
    background:#0f172a;
    padding:10px;
    border-radius:10px;
    margin-bottom:10px;
}
.item img{
    width:80px;
    height:80px;
    object-fit:cover;
    border-radius:8px;
    margin-right:10px;
}
.flex{
    display:flex;
    align-items:center;
}
.hapus{
    background:red;
    color:white;
    padding:5px 10px;
    border-radius:6px;
    margin-left:auto;
}
</style>
</head>
<body>

<div class="card">
<h2>Tambah Koleksi Pusaka SKH</h2>

<input id="nomor" placeholder="Nomor Sertifikat">
<input id="nama" placeholder="Nama Pusaka">
<input id="pemilik" placeholder="Pemilik">
<input id="jenis" placeholder="Jenis">
<input id="periode" placeholder="Periode">
<textarea id="deskripsi" placeholder="Deskripsi"></textarea>
<input type="file" id="foto" accept="image/*">

<div class="preview" id="preview"></div>

<button onclick="simpan()">Simpan</button>
<button class="logout" onclick="logout()">Logout</button>

<div class="list" id="daftarKoleksi"></div>

</div>

<script>

//////////////////////////////////////////////////
// VALIDASI LOGIN
//////////////////////////////////////////////////

if(localStorage.getItem("adminLogin") !== "true"){
    window.location.replace("index.html");
}

//////////////////////////////////////////////////
// DATABASE
//////////////////////////////////////////////////

function getDB(){
    return JSON.parse(localStorage.getItem("dataPusaka") || "[]");
}

function setDB(data){
    localStorage.setItem("dataPusaka", JSON.stringify(data));
}

let modeEdit = false;
let indexEdit = null;

//////////////////////////////////////////////////
// PREVIEW FOTO
//////////////////////////////////////////////////

document.getElementById("foto").addEventListener("change", function(){
    const file = this.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e){
        document.getElementById("preview").innerHTML =
        `<img src="${e.target.result}">`;
    };
    reader.readAsDataURL(file);
});

//////////////////////////////////////////////////
// SIMPAN / UPDATE DATA
//////////////////////////////////////////////////

function simpan(){

    let db = getDB();

    let nomor = document.getElementById("nomor").value.trim();
    let nama = document.getElementById("nama").value.trim();
    let pemilik = document.getElementById("pemilik").value.trim();
    let jenis = document.getElementById("jenis").value.trim();
    let periode = document.getElementById("periode").value.trim();
    let deskripsi = document.getElementById("deskripsi").value.trim();
    let file = document.getElementById("foto").files[0];

    if(!nomor || !nama){
        alert("Nomor dan Nama wajib diisi!");
        return;
    }

    // MODE TAMBAH BARU
    if(!modeEdit){

        if(!file){
            alert("Foto wajib diisi!");
            return;
        }

        if(db.find(d => d.nomor === nomor)){
            alert("Nomor sudah ada!");
            return;
        }

        const reader = new FileReader();

        reader.onload = function(e){

            db.push({
                nomor,
                nama,
                pemilik,
                jenis,
                periode,
                deskripsi,
                foto: e.target.result,
                timestamp: Date.now()
            });

            setDB(db);
            resetForm();
            tampilkanData();
            alert("Data berhasil disimpan!");
        };

        reader.readAsDataURL(file);
    }

    // MODE UPDATE
    else{

        let dataLama = db[indexEdit];

        if(file){
            const reader = new FileReader();
            reader.onload = function(e){
                dataLama.foto = e.target.result;
                simpanUpdate(db, dataLama, nomor,nama,pemilik,jenis,periode,deskripsi);
            };
            reader.readAsDataURL(file);
        }else{
            simpanUpdate(db, dataLama, nomor,nama,pemilik,jenis,periode,deskripsi);
        }
    }
}

function simpanUpdate(db, dataLama, nomor,nama,pemilik,jenis,periode,deskripsi){

    dataLama.nama = nama;
    dataLama.pemilik = pemilik;
    dataLama.jenis = jenis;
    dataLama.periode = periode;
    dataLama.deskripsi = deskripsi;
    dataLama.updateAt = Date.now();

    setDB(db);
    resetForm();
    tampilkanData();
    alert("Data berhasil diperbarui!");
}

//////////////////////////////////////////////////
// EDIT DATA
//////////////////////////////////////////////////

function edit(index){

    let db = getDB();
    let item = db[index];

    document.getElementById("nomor").value = item.nomor;
    document.getElementById("nama").value = item.nama;
    document.getElementById("pemilik").value = item.pemilik;
    document.getElementById("jenis").value = item.jenis;
    document.getElementById("periode").value = item.periode;
    document.getElementById("deskripsi").value = item.deskripsi;

    document.getElementById("nomor").disabled = true;

    document.getElementById("preview").innerHTML =
    `<img src="${item.foto}">`;

    modeEdit = true;
    indexEdit = index;

    window.scrollTo({top:0, behavior:'smooth'});
}

function batalEdit(){
    resetForm();
}

function resetForm(){
    document.getElementById("nomor").value="";
    document.getElementById("nama").value="";
    document.getElementById("pemilik").value="";
    document.getElementById("jenis").value="";
    document.getElementById("periode").value="";
    document.getElementById("deskripsi").value="";
    document.getElementById("foto").value="";
    document.getElementById("preview").innerHTML="";
    document.getElementById("nomor").disabled=false;

    modeEdit=false;
    indexEdit=null;
}

//////////////////////////////////////////////////
// TAMPILKAN DATA
//////////////////////////////////////////////////

function tampilkanData(){

    let db = getDB();
    let container = document.getElementById("daftarKoleksi");
    container.innerHTML = "<h3>Daftar Koleksi</h3>";

    if(db.length===0){
        container.innerHTML += "<p>Belum ada koleksi.</p>";
        return;
    }

    db.forEach((item,index)=>{
        container.innerHTML += `
        <div class="item">
            <div class="flex">
                <img src="${item.foto}">
                <div>
                    <strong>${item.nama}</strong><br>
                    Pemilik: ${item.pemilik || "-"}<br>
                    Jenis: ${item.jenis || "-"}<br>
                    <small>No: ${item.nomor}</small>
                </div>
                <button onclick="edit(${index})">Edit</button>
                <button class="hapus" onclick="hapus(${index})">Hapus</button>
            </div>
        </div>
        `;
    });
}

//////////////////////////////////////////////////
// HAPUS DATA
//////////////////////////////////////////////////

function hapus(index){
    let db = getDB();
    if(confirm("Yakin ingin menghapus koleksi ini?")){
        db.splice(index,1);
        setDB(db);
        tampilkanData();
    }
}

//////////////////////////////////////////////////
// LOGOUT
//////////////////////////////////////////////////

function logout(){
    localStorage.removeItem("adminLogin");
    window.location.replace("index.html");
}

tampilkanData();

</script>

</body>
</html>
