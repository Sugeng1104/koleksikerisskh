<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel SKH Level 3</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    font-family:Georgia,serif;
    background:#0f172a;
    color:white;
    padding:40px;
}
.card{
    max-width:900px;
    margin:auto;
    background:#1e293b;
    padding:25px;
    border-radius:14px;
}
input,textarea{
    width:100%;
    padding:10px;
    margin:6px 0;
    border-radius:8px;
    border:none;
}
button{
    padding:10px 18px;
    border:none;
    border-radius:8px;
    background:#d4af37;
    color:black;
    font-weight:bold;
    cursor:pointer;
    margin-top:5px;
}
.logout{background:red;color:white;}
.preview img{max-width:200px;border-radius:10px;margin-top:10px;border:2px solid gold;}
.item{
    background:#111827;
    padding:10px;
    border-radius:10px;
    margin-top:10px;
}
.flex{display:flex;align-items:center;}
.item img{width:80px;height:80px;object-fit:cover;border-radius:8px;margin-right:10px;}
.hapus{background:red;color:white;margin-left:auto;}
.edit{background:orange;color:black;margin-left:5px;}
canvas{background:white;border-radius:10px;margin-top:20px;}
.dropzone{
    border:2px dashed gold;
    padding:15px;
    text-align:center;
    margin-top:10px;
    cursor:pointer;
}
</style>
</head>
<body>

<div class="card">
<h2>Admin Koleksi Pusaka SKH - Level 3</h2>

<input id="nomor" placeholder="Nomor Sertifikat">
<input id="nama" placeholder="Nama Pusaka">
<input id="pemilik" placeholder="Pemilik">
<input id="jenis" placeholder="Jenis">
<input id="periode" placeholder="Periode">
<textarea id="deskripsi" placeholder="Deskripsi"></textarea>

<div class="dropzone" id="dropzone">
Drag & Drop Foto di sini atau klik untuk pilih
<input type="file" id="foto" accept="image/*" style="display:none">
</div>

<div class="preview" id="preview"></div>

<button onclick="simpan()">Simpan / Update</button>
<button class="logout" onclick="logout()">Logout</button>

<hr>

<h3>Statistik Koleksi</h3>
<canvas id="chart" height="120"></canvas>

<hr>

<h3>Daftar Koleksi</h3>
<div id="daftarKoleksi"></div>

</div>

<script>
//////////////////////////////////////////////////
// KONFIGURASI WEB APP
//////////////////////////////////////////////////
const API_URL="https://script.google.com/macros/s/AKfycbyxp18VDz5srBz9VrCYL8MqpSTczOHqf179x83nPYg1TlHr2erB1KCLKGrglUBsDptkwA/exec";

//////////////////////////////////////////////////
// LOGIN CHECK
//////////////////////////////////////////////////
if(localStorage.getItem("adminLogin")!=="true"){
    window.location.replace("index.html");
}

//////////////////////////////////////////////////
// DRAG DROP
//////////////////////////////////////////////////
const dropzone=document.getElementById("dropzone");
const fileInput=document.getElementById("foto");

dropzone.onclick=()=>fileInput.click();
dropzone.ondragover=e=>{e.preventDefault();dropzone.style.background="#334155";}
dropzone.ondragleave=e=>{dropzone.style.background="transparent";}
dropzone.ondrop=e=>{
    e.preventDefault();
    fileInput.files=e.dataTransfer.files;
    previewImage();
};
fileInput.addEventListener("change",previewImage);

function previewImage(){
    const file=fileInput.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{
        document.getElementById("preview").innerHTML=
        `<img src="${e.target.result}">`;
    };
    reader.readAsDataURL(file);
}

//////////////////////////////////////////////////
// HASH
//////////////////////////////////////////////////
function generateHash(nomor,nama){
    return btoa(nomor+nama+Date.now()).substring(0,20);
}

//////////////////////////////////////////////////
// SIMPAN ONLINE
//////////////////////////////////////////////////
let editNomor=null;

function simpan(){

    let nomor=document.getElementById("nomor").value.trim();
    let nama=document.getElementById("nama").value.trim();
    let pemilik=document.getElementById("pemilik").value.trim();
    let jenis=document.getElementById("jenis").value.trim();
    let periode=document.getElementById("periode").value.trim();
    let deskripsi=document.getElementById("deskripsi").value.trim();
    let file=fileInput.files[0];

    if(!nomor||!nama){
        alert("Nomor dan Nama wajib diisi!");
        return;
    }

    if(!file && !editNomor){
        alert("Foto wajib diisi!");
        return;
    }

    if(file){
        const reader=new FileReader();
        reader.onload=e=>kirimData(e.target.result);
        reader.readAsDataURL(file);
    }else{
        kirimData(document.querySelector("#preview img")?.src||"");
    }

    function kirimData(fotoData){
        fetch(API_URL,{
            method:"POST",
            body:JSON.stringify({
                action:"save",
                nomor,nama,pemilik,jenis,periode,deskripsi,
                foto:fotoData,
                hash:generateHash(nomor,nama)
            })
        })
        .then(res=>res.json())
        .then(()=>{
            alert("Data berhasil disimpan!");
            resetForm();
            tampilkanData();
        });
    }
}

//////////////////////////////////////////////////
// LOAD DATA ONLINE
//////////////////////////////////////////////////
function tampilkanData(){
    fetch(API_URL+"?action=get")
    .then(res=>res.json())
    .then(data=>{
        let container=document.getElementById("daftarKoleksi");
        container.innerHTML="";

        data.forEach(item=>{
            container.innerHTML+=`
            <div class="item">
                <div class="flex">
                    <img src="${item.foto}">
                    <div>
                        <strong>${item.nama}</strong><br>
                        Pemilik: ${item.pemilik||"-"}<br>
                        Jenis: ${item.jenis||"-"}<br>
                        <small>No: ${item.nomor}</small>
                    </div>
                </div>
            </div>`;
        });

        updateChart(data);
    });
}

//////////////////////////////////////////////////
// CHART
//////////////////////////////////////////////////
let chart;

function updateChart(data){
    let map={};
    data.forEach(item=>{
        let j=item.jenis||"Lainnya";
        map[j]=(map[j]||0)+1;
    });

    let labels=Object.keys(map);
    let values=Object.values(map);

    if(chart) chart.destroy();

    chart=new Chart(document.getElementById("chart"),{
        type:"bar",
        data:{
            labels:labels,
            datasets:[{
                label:"Jumlah Koleksi",
                data:values,
                backgroundColor:"gold"
            }]
        }
    });
}

//////////////////////////////////////////////////
// RESET
//////////////////////////////////////////////////
function resetForm(){
    document.querySelectorAll("input,textarea").forEach(el=>el.value="");
    document.getElementById("preview").innerHTML="";
}

//////////////////////////////////////////////////
// LOGOUT
//////////////////////////////////////////////////
function logout(){
    localStorage.removeItem("adminLogin");
    window.location.replace("index.html");
}

tampilkanData();
</script>

</body>
</html>
