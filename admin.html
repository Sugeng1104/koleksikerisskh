<!DOCTYPE html>
<html>
<head>
<title>Dashboard Admin</title>
<style>
body{
  margin:0;
  background:linear-gradient(to right,black,#001f1f);
  color:#00ffcc;
  font-family:Arial;
}
.sidebar{
  width:220px;
  height:100vh;
  background:black;
  position:fixed;
  padding:20px;
}
.sidebar button{
  width:100%;
  padding:10px;
  margin-top:10px;
  background:#00ffcc;
  border:none;
  cursor:pointer;
}
.content{
  margin-left:240px;
  padding:30px;
}
.flex-row{
  display:flex;
  gap:20px;
  align-items:flex-start;
}
.card{
  background:#111;
  padding:20px;
  border-radius:10px;
  margin-bottom:20px;
  flex:1;
}
input,select{
  padding:8px;
  margin-right:5px;
}
button.tambah{
  background:#00cc66;
  color:white;
  border:none;
  padding:8px 12px;
}
button.hapus{
  background:red;
  color:white;
  border:none;
  padding:6px 10px;
}
table{
  width:100%;
  margin-top:15px;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #333;
}
.stat-box{
  font-size:18px;
  margin-bottom:10px;
}
</style>
</head>
<body>

<div class="sidebar">
  <h2>ADMIN</h2>
  <p id="userInfo"></p>
  <p id="roleInfo"></p>

  <button onclick="window.location.href='index.html'">Halaman Depan</button>

  <button id="menuKelola" style="display:none;"
          onclick="window.location.href='kelola-akun.html'">
    Kelola Akun
  </button>

  <button onclick="logout()">Logout</button>
</div>

<div class="content">
  <h1>Dashboard Admin</h1>

  <div class="flex-row">

    <!-- STRUKTUR PENGURUS -->
    <div class="card">
      <h2>Struktur Pengurus</h2>
      <input type="text" id="namaPengurus" placeholder="Nama Pengurus">
      <select id="jabatan">
       <option>Ketua</option>
       <option>Sekretaris</option>
       <option>Bendahara</option>
       <option>Kurator Pusaka</option>
      </select>
      <button class="tambah" onclick="tambahPengurus()">Tambah</button>
      <ul id="listPengurus"></ul>
    </div>

    <!-- STATISTIK -->
    <div class="card">
      <h2>Statistik Anggota</h2>
      <div class="stat-box">Total Anggota: <strong id="totalAnggota">0</strong></div>
      <div class="stat-box">Aktif: <strong id="totalAktif">0</strong></div>
      <div class="stat-box">Nonaktif: <strong id="totalNonaktif">0</strong></div>
    </div>

  </div>

  <!-- DAFTAR ANGGOTA -->
  <div class="card">
    <h2>Daftar Anggota</h2>

    <div style="margin-bottom:10px;">
      <input type="text" id="searchInput" placeholder="Cari Nama / No Anggota..." onkeyup="renderTabel()">
      <select id="filterStatus" onchange="renderTabel()">
        <option value="">Semua Status</option>
        <option value="Aktif">Aktif</option>
        <option value="Nonaktif">Nonaktif</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>No Anggota</th>
          <th>Nama</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tabelAnggota">
        <tr><td colspan="4">Memuat...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxgBRf27sB3bMFNTTTfJ6ZGBAGe2xJ0Wn1cln5afaeUSL3Wcm4HMqHeSJFBU3yK60ik6A/exec";

//////////////////////////////////////////////////
// CEK LOGIN
//////////////////////////////////////////////////

if(localStorage.getItem("isLoggedIn")!=="true"){
  window.location.href="login.html";
}

const username=localStorage.getItem("username");
const role=localStorage.getItem("role");

document.getElementById("userInfo").innerText="User: "+username;
document.getElementById("roleInfo").innerText="Role: "+role;

if(role==="Super Admin"){
  document.getElementById("menuKelola").style.display="block";
}

function logout(){
  localStorage.clear();
  window.location.href="https://sugeng1104.github.io/koleksikerisskh/index.html";
}

//////////////////////////////////////////////////
// LOADING SPINNER
//////////////////////////////////////////////////

function showLoading(){
  document.getElementById("tabelAnggota").innerHTML =
  "<tr><td colspan='4'>Memuat data...</td></tr>";
}

//////////////////////////////////////////////////
// STRUKTUR PENGURUS (HANYA DARI ANGGOTA AKTIF)
//////////////////////////////////////////////////

let pengurus = JSON.parse(localStorage.getItem("pengurus")) || [];

function isiDropdownPengurus(){
  const select = document.getElementById("namaPengurus");
  select.innerHTML = "";
  const aktif = allData.filter(a=>a.Status==="Aktif");
  aktif.forEach(a=>{
    const opt=document.createElement("option");
    opt.value=a["Nama Lengkap"];
    opt.textContent=a["Nama Lengkap"];
    select.appendChild(opt);
  });
}

function tampilPengurus(){
  const list=document.getElementById("listPengurus");
  list.innerHTML="";
  if(pengurus.length===0){
    list.innerHTML="<li>Belum ada pengurus</li>";
    return;
  }
  pengurus.forEach((p,i)=>{
    list.innerHTML+=`
      <li>
        ${p.nama} - ${p.jabatan}
        <button class="hapus" onclick="hapusPengurus(${i})">Hapus</button>
      </li>
    `;
  });
}

function tambahPengurus(){
  const nama=document.getElementById("namaPengurus").value;
  const jabatan=document.getElementById("jabatan").value;
  if(!nama) return alert("Pilih nama!");
  pengurus.push({nama,jabatan});
  localStorage.setItem("pengurus",JSON.stringify(pengurus));
  tampilPengurus();
}

function hapusPengurus(i){
  pengurus.splice(i,1);
  localStorage.setItem("pengurus",JSON.stringify(pengurus));
  tampilPengurus();
}

tampilPengurus();

//////////////////////////////////////////////////
// DATA ANGGOTA + PAGINATION
//////////////////////////////////////////////////

let allData=[];
let currentPage=1;
const rowsPerPage=10;

async function loadAnggota(){
  showLoading();
  try{
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();
    allData = data || [];
    updateStatistik();
    isiDropdownPengurus();
    renderTabel();
  }catch(error){
    document.getElementById("tabelAnggota").innerHTML=
    "<tr><td colspan='4'>Gagal memuat data</td></tr>";
  }
}

function updateStatistik(){
  const total = allData.length;
  const aktif = allData.filter(a=>a.Status==="Aktif").length;
  const nonaktif = total - aktif;
  document.getElementById("totalAnggota").innerText=total;
  document.getElementById("totalAktif").innerText=aktif;
  document.getElementById("totalNonaktif").innerText=nonaktif;
}

function getFilteredData(){
  const search=document.getElementById("searchInput").value.toLowerCase();
  const filter=document.getElementById("filterStatus").value;
  return allData.filter(row=>{
    const nama=(row["Nama Lengkap"]||"").toLowerCase();
    const no=(row["No Anggota"]||"").toLowerCase();
    const status=row.Status||"Nonaktif";
    return (
      (nama.includes(search) || no.includes(search)) &&
      (filter==="" || status===filter)
    );
  });
}

function renderTabel(){

  const filtered=getFilteredData();
  const start=(currentPage-1)*rowsPerPage;
  const end=start+rowsPerPage;
  const pageData=filtered.slice(start,end);

  let html="";
  pageData.forEach(row=>{
    const status=row.Status||"Nonaktif";
    html+=`
      <tr>
        <td>${row["No Anggota"]||"-"}</td>
        <td>${row["Nama Lengkap"]||"-"}</td>
        <td>
          <select onchange="ubahStatus('${row["No Anggota"]}', this.value)">
            <option ${status==="Aktif"?"selected":""}>Aktif</option>
            <option ${status==="Nonaktif"?"selected":""}>Nonaktif</option>
          </select>
        </td>
        <td>
          <button class="hapus" onclick="hapusAnggota('${row["No Anggota"]}')">Hapus</button>
        </td>
      </tr>
    `;
  });

  document.getElementById("tabelAnggota").innerHTML =
    pageData.length ? html :
    "<tr><td colspan='4'>Data tidak ditemukan</td></tr>";

  renderPagination(filtered.length);
}

function renderPagination(totalRows){
  const totalPages=Math.ceil(totalRows/rowsPerPage);
  if(totalPages<=1) return;

  let controls=`
    <div style="margin-top:10px;">
      <button onclick="prevPage()">Prev</button>
      Halaman ${currentPage} dari ${totalPages}
      <button onclick="nextPage(${totalPages})">Next</button>
      <button onclick="exportExcel()">Export Excel</button>
    </div>
  `;
  document.querySelector(".card:last-child").innerHTML+=controls;
}

function prevPage(){
  if(currentPage>1){
    currentPage--;
    renderTabel();
  }
}

function nextPage(totalPages){
  if(currentPage<totalPages){
    currentPage++;
    renderTabel();
  }
}

//////////////////////////////////////////////////
// UPDATE TANPA RELOAD PENUH
//////////////////////////////////////////////////

async function ubahStatus(no,status){
  const formData = new URLSearchParams();
  formData.append("action","updateStatus");
  formData.append("no",no);
  formData.append("status",status);
  await fetch(WEB_APP_URL,{method:"POST",body:formData});
  const item=allData.find(a=>a["No Anggota"]===no);
  if(item) item.Status=status;
  updateStatistik();
  renderTabel();
  alert("Status berhasil diperbarui");
}

async function hapusAnggota(no){
  if(!confirm("Yakin ingin menghapus anggota ini?")) return;
  const formData = new URLSearchParams();
  formData.append("action","delete");
  formData.append("no",no);
  await fetch(WEB_APP_URL,{method:"POST",body:formData});
  allData=allData.filter(a=>a["No Anggota"]!==no);
  updateStatistik();
  renderTabel();
}

//////////////////////////////////////////////////
// EXPORT EXCEL
//////////////////////////////////////////////////

function exportExcel(){
  const data=getFilteredData();
  if(data.length===0) return alert("Tidak ada data untuk diexport");

  let csv="";
  const headers=Object.keys(data[0]);
  csv+=headers.join(",")+"\n";

  data.forEach(row=>{
    csv+=headers.map(h=>`"${row[h]||""}"`).join(",")+"\n";
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="data-anggota.csv";
  a.click();
}

loadAnggota();

</script>

</body>
</html>
