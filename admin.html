<!DOCTYPE html>
<html>
<head>
<title>Dashboard Admin</title>
<style>
body{
  margin:0;
  background:linear-gradient(to right,black,#001f1f);
  color:#00ffcc;
  font-family:Arial;
}
.sidebar{
  width:220px;
  height:100vh;
  background:black;
  position:fixed;
  padding:20px;
}
.sidebar button{
  width:100%;
  padding:10px;
  margin-top:10px;
  background:#00ffcc;
  border:none;
  cursor:pointer;
}
.content{
  margin-left:240px;
  padding:30px;
}
.card{
  background:#111;
  padding:20px;
  border-radius:10px;
  margin-bottom:20px;
}
input,select{
  padding:8px;
}
button.tambah{
  background:#00cc66;
  color:white;
  border:none;
  padding:8px 12px;
}
button.hapus{
  background:red;
  color:white;
  border:none;
  padding:6px 10px;
}
table{
  width:100%;
  margin-top:15px;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #333;
}
</style>
</head>
<body>

<div class="sidebar">
  <h2>ADMIN</h2>
  <p id="userInfo"></p>
  <p id="roleInfo"></p>

  <button onclick="window.location.href='index.html'">Halaman Depan</button>

  <button id="menuKelola" style="display:none;"
          onclick="window.location.href='kelola-akun.html'">
    Kelola Akun
  </button>

  <button onclick="logout()">Logout</button>
</div>

<div class="content">
  <h1>Dashboard Admin</h1>

  <!-- STRUKTUR PENGURUS -->
  <div class="card">
    <h2>Struktur Pengurus</h2>
    <input type="text" id="namaPengurus" placeholder="Nama Pengurus">
    <select id="jabatan">
     <option>Ketua</option>
     <option>Sekertaris</option>
     <option>Bendahara</option>
     <option>Korektor Pusaka</option>
    </select>
    <button class="tambah" onclick="tambahPengurus()">Tambah</button>
    <ul id="listPengurus"></ul>
  </div>

  <!-- DAFTAR ANGGOTA -->
  <div class="card">
    <h2>Daftar Anggota</h2>

    <table>
      <thead>
        <tr>
          <th>No Anggota</th>
          <th>Nama</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tabelAnggota">
        <tr><td colspan="4">Memuat...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>

//////////////////////////////////////////////////
// URL SERVER (SAMA DENGAN daftar-anggota.html)
//////////////////////////////////////////////////

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxgBRf27sB3bMFNTTTfJ6ZGBAGe2xJ0Wn1cln5afaeUSL3Wcm4HMqHeSJFBU3yK60ik6A/exec";

//////////////////////////////////////////////////
// CEK LOGIN
//////////////////////////////////////////////////

if(
  localStorage.getItem("isLoggedIn")!=="true" ||
  !localStorage.getItem("username") ||
  !localStorage.getItem("role")
){
  window.location.href="login.html";
}

const username=localStorage.getItem("username");
const role=localStorage.getItem("role");

document.getElementById("userInfo").innerText="User: "+username;
document.getElementById("roleInfo").innerText="Role: "+role;

if(role==="Super Admin"){
  document.getElementById("menuKelola").style.display="block";
}

function logout(){
  localStorage.removeItem("isLoggedIn");
  localStorage.removeItem("username");
  localStorage.removeItem("role");
  window.location.href="login.html";
}

//////////////////////////////////////////////////
// STRUKTUR PENGURUS (TETAP LOCAL STORAGE)
//////////////////////////////////////////////////

let pengurus = JSON.parse(localStorage.getItem("pengurus")) || [];

function tampilPengurus(){
  const list=document.getElementById("listPengurus");
  list.innerHTML="";

  if(pengurus.length===0){
    list.innerHTML="<li>Belum ada pengurus</li>";
    return;
  }

  pengurus.forEach((p,i)=>{
    list.innerHTML+=`
      <li>
        ${p.nama} - ${p.jabatan}
        <button class="hapus" onclick="hapusPengurus(${i})">Hapus</button>
      </li>
    `;
  });
}

function tambahPengurus(){
  const nama=document.getElementById("namaPengurus").value.trim();
  const jabatan=document.getElementById("jabatan").value;

  if(nama==="") return alert("Isi nama!");

  pengurus.push({nama,jabatan});
  localStorage.setItem("pengurus",JSON.stringify(pengurus));
  document.getElementById("namaPengurus").value="";
  tampilPengurus();
}

function hapusPengurus(i){
  pengurus.splice(i,1);
  localStorage.setItem("pengurus",JSON.stringify(pengurus));
  tampilPengurus();
}

tampilPengurus();

//////////////////////////////////////////////////
// LOAD ANGGOTA DARI SERVER (FIX UTAMA)
//////////////////////////////////////////////////

async function loadAnggota(){
  const tabel=document.getElementById("tabelAnggota");
  tabel.innerHTML="<tr><td colspan='4'>Memuat...</td></tr>";

  try{
    const res = await fetch(WEB_APP_URL);
    const result = await res.json();
    const data = result.data || result;

    if(!data || data.length===0){
      tabel.innerHTML="<tr><td colspan='4'>Belum ada anggota</td></tr>";
      return;
    }

    let html="";

    data.forEach((row,i)=>{
      const status=row.Status||"Nonaktif";

      html+=`
        <tr>
          <td>${row["No Anggota"]||"-"}</td>
          <td>${row["Nama Lengkap"]||"-"}</td>
          <td>
            <select onchange="ubahStatus('${row["No Anggota"]}', this.value)">
              <option ${status==="Aktif"?"selected":""}>Aktif</option>
              <option ${status==="Nonaktif"?"selected":""}>Nonaktif</option>
            </select>
          </td>
          <td>
            <button class="hapus" onclick="hapusAnggota('${row["No Anggota"]}')">Hapus</button>
          </td>
        </tr>
      `;
    });

    tabel.innerHTML=html;

  }catch(error){
    tabel.innerHTML="<tr><td colspan='4'>Gagal memuat data</td></tr>";
    console.error(error);
  }
}

loadAnggota();

//////////////////////////////////////////////////
// UBAH STATUS (KIRIM KE SERVER)
//////////////////////////////////////////////////

async function ubahStatus(no,status){

  const formData = new URLSearchParams();
  formData.append("action","updateStatus");
  formData.append("no",no);
  formData.append("status",status);

  try{
    await fetch(WEB_APP_URL,{
      method:"POST",
      body:formData
    });
  }catch(error){
    alert("Gagal update status");
    console.error(error);
  }
}

//////////////////////////////////////////////////
// HAPUS ANGGOTA (KIRIM KE SERVER)
//////////////////////////////////////////////////

async function hapusAnggota(no){

  if(!confirm("Yakin ingin menghapus anggota ini?")) return;

  const formData = new URLSearchParams();
  formData.append("action","delete");
  formData.append("no",no);

  try{
    await fetch(WEB_APP_URL,{
      method:"POST",
      body:formData
    });

    loadAnggota();

  }catch(error){
    alert("Gagal menghapus anggota");
    console.error(error);
  }
}

</script>

</body>
</html>
