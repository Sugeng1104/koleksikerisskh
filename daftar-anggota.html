<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Komunitas Keris SKH</title>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body{margin:0;font-family:Georgia,serif;background:#000;color:white;padding:40px;}
.container{max-width:1100px;margin:auto;}
h1{color:gold;text-align:center;margin-bottom:40px;text-shadow:0 0 10px rgba(212,175,55,0.6);}
.card{background:#111;padding:30px;border-radius:15px;margin-bottom:25px;box-shadow:0 0 20px rgba(212,175,55,0.3);}
h2{color:gold;margin-bottom:15px;}
.pengurus-list{font-size:18px;line-height:1.8;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #444;padding:10px;}
th{background:#222;color:gold;}
.foto-kecil{width:55px;height:55px;object-fit:cover;border-radius:8px;border:2px solid gold;}
.status-aktif{background:#00aa00;padding:5px 10px;border-radius:6px;font-weight:bold;}
.btn{padding:10px 20px;border-radius:8px;margin-right:10px;font-weight:bold;border:none;cursor:pointer;}
.btn-blue{background:#007bff;color:white;}
.btn-green{background:#28a745;color:white;}
.btn-gold{background:gold;color:black;}
.button-group{margin-top:15px;}
.loading{text-align:center;color:gold;}
</style>
</head>
<body>

<div class="container">
<h1>Komunitas Keris SKH</h1>

<div class="card">
<h2>Struktur Pengurus</h2>
<div class="pengurus-list" id="strukturPengurus">Memuat struktur...</div>
</div>

<div class="card">
<h2>Daftar Anggota</h2>

<table>
<thead>
<tr>
<th>Foto</th>
<th>Nama</th>
<th>No Anggota</th>
<th>Status</th>
</tr>
</thead>
<tbody id="listAnggota">
<tr><td colspan="4" class="loading">Memuat data...</td></tr>
</tbody>
</table>

<div class="button-group">
<a href="index.html"><button class="btn btn-gold">Kembali</button></a>
</div>

</div>
</div>

<script>

const WEB_APP_URL = "YOUR_WEB_APP_URL";
let cacheHash = "";

/* ================================
   RENDER DATA
================================ */
function renderData(anggotaData, pengurusData){

    const container = document.getElementById("strukturPengurus");
    const tbody = document.getElementById("listAnggota");

    let ketua="-", sekretaris="-", bendahara="-", kurator="-";

    const pengurusAktif = (pengurusData||[])
        .filter(p=>p.Status==="Aktif");

    pengurusAktif.forEach(p=>{
        if(p.Jabatan==="Ketua") ketua=p.Nama;
        if(p.Jabatan==="Sekretaris") sekretaris=p.Nama;
        if(p.Jabatan==="Bendahara") bendahara=p.Nama;
        if(p.Jabatan==="Kurator Pusaka") kurator=p.Nama;
    });

    container.innerHTML=`
    Ketua : <strong>${ketua}</strong><br>
    Sekretaris : ${sekretaris}<br>
    Bendahara : ${bendahara}<br>
    Kurator Pusaka : ${kurator}
    `;

    const namaPengurus = pengurusAktif.map(p=>p.Nama);

    let html="";

    (anggotaData||[])
    .filter(a=>a.Status==="Aktif")
    .reverse()
    .forEach(a=>{

        const isPengurus = namaPengurus.includes(a["Nama Lengkap"]);

        const badge = isPengurus
        ? ` <span style="background:gold;color:black;padding:3px 8px;border-radius:6px;font-size:12px;margin-left:6px;">Pengurus</span>`
        : "";

        html+=`
        <tr>
            <td><img src="${a.Foto||""}" class="foto-kecil"></td>
            <td>${a["Nama Lengkap"]||"-"}${badge}</td>
            <td>${a["No Anggota"]||"-"}</td>
            <td><span class="status-aktif">Aktif</span></td>
        </tr>`;
    });

    tbody.innerHTML = html || "<tr><td colspan='4'>Belum ada anggota aktif</td></tr>";
}

/* ================================
   REALTIME STREAM LOOP
================================ */
async function startRealtime(){

    while(true){

        try{

            const res = await fetch(WEB_APP_URL + "?action=stream");
            const result = await res.json();

            const anggota = result.anggota || [];
            const pengurus = result.pengurus || [];

            const newHash = btoa(JSON.stringify(result));

            if(newHash !== cacheHash){
                renderData(anggota, pengurus);
                cacheHash = newHash;
            }

        }catch(e){
            console.log("Reconnect...");
        }

        await new Promise(r=>setTimeout(r,2000)); 
        // bukan polling interval, ini reconnect delay
    }
}

/* INIT */
startRealtime();

</script>

</body>
</html>
