<!-- HANYA SCRIPT BAGIAN BAWAH YANG DIGANTI TOTAL -->
<script>

/* ================================
   AUTO REDIRECT JIKA SUDAH LOGIN
================================ */
(function(){
    const isLoggedIn = localStorage.getItem("isLoggedIn");
    const role = localStorage.getItem("role");
    if(isLoggedIn === "true" && role){
        window.location.href =
        "https://sugeng1104.github.io/koleksikerisskh/anggota/dashboard-daftar-anggota.html";
    }
})();

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxgBRf27sB3bMFNTTTfJ6ZGBAGe2xJ0Wn1cln5afaeUSL3Wcm4HMqHeSJFBU3yK60ik6A/exec";

let submitting=false;

/* ================================
   KOMPRES GAMBAR SUPER CEPAT
================================ */
function compressImage(file){

    return new Promise((resolve)=>{

        const reader=new FileReader();

        reader.onload=function(e){

            const img=new Image();
            img.src=e.target.result;

            img.onload=function(){

                const canvas=document.createElement("canvas");
                const MAX_WIDTH=800;

                let width=img.width;
                let height=img.height;

                if(width>MAX_WIDTH){
                    height*=MAX_WIDTH/width;
                    width=MAX_WIDTH;
                }

                canvas.width=width;
                canvas.height=height;

                const ctx=canvas.getContext("2d");
                ctx.drawImage(img,0,0,width,height);

                resolve(canvas.toDataURL("image/jpeg",0.7)); // kompres 70%
            };
        };

        reader.readAsDataURL(file);
    });
}

/* ================================
   KIRIM DATA CEPAT
================================ */
async function kirim(){

    if(submitting) return;
    submitting=true;

    const btn=document.getElementById("btnKirim");
    btn.disabled=true;
    btn.innerText="Memproses...";

    const nama=document.getElementById("nama").value.trim();
    const gelar=document.getElementById("gelar").value;
    const file=document.getElementById("foto").files[0];

    if(!nama || !file){
        alert("Nama dan Foto wajib diisi");
        resetButton();
        return;
    }

    try{

        // ðŸ”¥ Kompres dulu
        const compressedImage = await compressImage(file);

        btn.innerText="Mengirim...";

        const formData = new URLSearchParams();
        formData.append("action","add");
        formData.append("nama",nama);
        formData.append("gelar",gelar);
        formData.append("foto",compressedImage);

        // â± Timeout 20 detik
        const controller = new AbortController();
        const timeout = setTimeout(()=>controller.abort(),20000);

        const res = await fetch(WEB_APP_URL,{
            method:"POST",
            body:formData,
            signal:controller.signal
        });

        clearTimeout(timeout);

        const result = await res.json();

        if(result.status==="success"){

            const nomor=result.nomor || "SKH-"+Date.now();

            // Buat akun otomatis
            let users = JSON.parse(localStorage.getItem("adminUsers")) || [];
            let newUsername = nama.replace(/\s+/g,"").toLowerCase();
            let newPassword = newUsername + "@";

            if(!users.find(u => u.username === newUsername)){
                users.push({
                    username:newUsername,
                    password:newPassword,
                    role:"User"
                });
                localStorage.setItem("adminUsers", JSON.stringify(users));
            }

            alert("Berhasil terdaftar!\n\nUsername: "+newUsername+"\nPassword: "+newPassword);

            document.getElementById("nama").value="";
            document.getElementById("gelar").value="";
            document.getElementById("foto").value="";

            tutupForm();
            loadAnggota();
        }

    }catch(e){
        alert("Server lambat / koneksi bermasalah. Silakan coba lagi.");
    }

    resetButton();
}

function resetButton(){
    submitting=false;
    const btn=document.getElementById("btnKirim");
    btn.disabled=false;
    btn.innerText="Kirim";
}

loadStruktur();
loadAnggota();

</script>
