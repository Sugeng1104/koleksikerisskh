<script>

const WEB_APP_URL="https://script.google.com/macros/s/AKfycbxgBRf27sB3bMFNTTTfJ6ZGBAGe2xJ0Wn1cln5afaeUSL3Wcm4HMqHeSJFBU3yK60ik6A/exec";

let lastNomor="";
let lastCanvas=null;

/* ================================
   LOAD ANGGOTA
================================ */
async function loadAnggota(){
    try{
        const res=await fetch(WEB_APP_URL);
        const result=await res.json();
        const data=result.data||result;

        const tbody=document.getElementById("listAnggota");

        if(!data||data.length===0){
            tbody.innerHTML="<tr><td colspan='5'>Belum ada anggota</td></tr>";
            return;
        }

        tbody.innerHTML="";

        data.slice().reverse().forEach(row=>{

            const status=row.Status||"Nonaktif";
            const statusClass=status==="Aktif"?"status-aktif":"status-nonaktif";

            const tr=document.createElement("tr");

            tr.innerHTML=`
                <td><img src="${row.Foto||""}" class="foto-kecil"></td>
                <td>${row["Nama Lengkap"]||"-"}</td>
                <td>${row["No Anggota"]||"-"}</td>
                <td><span class="${statusClass}">${status}</span></td>
                <td><button class="btn btn-green">Cetak Kartu</button></td>
            `;

            const btn=tr.querySelector("button");

            btn.addEventListener("click",function(){
                previewKartu(
                    row["Nama Lengkap"]||"",
                    row["Gelar"]||"",
                    row["No Anggota"]||"",
                    row["Foto"]||""
                );
            });

            tbody.appendChild(tr);
        });

    }catch(e){
        document.getElementById("listAnggota").innerHTML=
        "<tr><td colspan='5'>Gagal memuat data</td></tr>";
    }
}

/* ================================
   PREVIEW KARTU
================================ */
function previewKartu(nama,gelar,nomor,foto){

    lastNomor=nomor;

    const modal=document.getElementById("modalPreview");
    const canvas=document.getElementById("previewCanvas");
    const ctx=canvas.getContext("2d");

    canvas.width=1016;
    canvas.height=638;
    lastCanvas=canvas;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle="#111";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Watermark
    const watermark=new Image();
    watermark.src="logo-skh.png";

    watermark.onload=function(){
        ctx.globalAlpha=0.08;
        ctx.drawImage(watermark,canvas.width/2-250,canvas.height/2-250,500,500);
        ctx.globalAlpha=1;
        renderContent();
    };

    watermark.onerror=function(){
        renderContent();
    };

    function renderContent(){

        ctx.fillStyle="gold";
        ctx.font="bold 48px Georgia";
        ctx.textAlign="center";
        ctx.fillText("Komunitas Keris SKH",canvas.width/2,90);

        const img=new Image();
        img.crossOrigin="anonymous";
        img.src=foto;

        img.onload=function(){
            ctx.drawImage(img,80,200,200,250);
            drawText();
        };

        img.onerror=function(){
            drawText();
        };

        function drawText(){

            ctx.textAlign="left";
            ctx.fillStyle="white";
            ctx.font="bold 40px Georgia";
            ctx.fillText(nama,320,260);

            ctx.font="30px Georgia";
            ctx.fillText(gelar||"",320,320);
            ctx.fillText("No: "+nomor,320,380);

            QRCode.toCanvas(nomor,{width:200},function(err,qrCanvas){
                if(!err){
                    ctx.drawImage(qrCanvas,canvas.width/2-100,420);
                }

                ctx.font="22px Georgia";
                ctx.textAlign="center";
                ctx.fillText("Tanda Tangan Digital",canvas.width/2,600);

                modal.style.display="flex";
            });
        }
    }
}

/* ================================
   DOWNLOAD
================================ */
function downloadKartu(){
    if(!lastCanvas) return;
    const link=document.createElement("a");
    link.download="Kartu_"+lastNomor+".png";
    link.href=lastCanvas.toDataURL("image/png");
    link.click();
}

/* ================================
   TUTUP PREVIEW
================================ */
function tutupPreview(){
    document.getElementById("modalPreview").style.display="none";
}

document.addEventListener("DOMContentLoaded",function(){
    loadAnggota();
});

</script>
